<template>
    <div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100">
        <!-- Modern Navigation -->
        <nav class="bg-white/80 backdrop-blur-md shadow-lg border-b border-white/20 sticky top-0 z-50">
            <div class="px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-8">
                        <div class="flex items-center space-x-4">
                            <div class="relative">
                                <div class="w-12 h-12 bg-gradient-to-br from-cyan-600 to-cyan-700 rounded-xl flex items-center justify-center shadow-lg">
                                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/>
                                    </svg>
                                </div>
                                <div class="absolute -top-1 -right-1 w-4 h-4 bg-green-500 rounded-full animate-pulse"></div>
                            </div>
                            <div>
                                <h1 class="text-2xl font-bold bg-gradient-to-r from-gray-900 to-gray-700 bg-clip-text text-transparent">
                                    Weather & Logistics Intelligence
                                </h1>
                                <p class="text-gray-600 text-sm flex items-center">
                                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse mr-2"></div>
                                    Real-time Weather & Route Optimization
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-6">
                            <a href="/" class="px-4 py-2 text-sm font-medium transition-all duration-200 rounded-lg text-gray-500 hover:text-gray-700 hover:bg-gray-50">
                                <div class="flex items-center space-x-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v2H8V5z"/>
                                    </svg>
                                    <span>Dashboard</span>
                                </div>
                            </a>
                            <a href="/transportation-management" class="px-4 py-2 text-sm font-medium transition-all duration-200 rounded-lg text-gray-500 hover:text-gray-700 hover:bg-gray-50">
                                <div class="flex items-center space-x-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                                    </svg>
                                    <span>Transportation</span>
                                </div>
                            </a>
                            <a href="/delivery-management" class="px-4 py-2 text-sm font-medium transition-all duration-200 rounded-lg text-gray-500 hover:text-gray-700 hover:bg-gray-50">
                                <div class="flex items-center space-x-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                                    </svg>
                                    <span>Delivery</span>
                                </div>
                            </a>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-3 px-4 py-2 bg-white/50 backdrop-blur-sm rounded-lg border border-white/20">
                            <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse shadow-lg"></div>
                            <span class="text-sm font-medium text-gray-700">Live</span>
                        </div>
                        <div class="text-sm text-gray-500 px-3 py-2 bg-white/30 backdrop-blur-sm rounded-lg border border-white/20">
                            {{ formatTime(new Date()) }}
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <div class="px-6 py-6">
            <!-- Header Section -->
            <div class="mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-bold bg-gradient-to-r from-gray-900 via-cyan-800 to-blue-800 bg-clip-text text-transparent mb-2">
                            Weather & Logistics Intelligence
                        </h2>
                        <p class="text-gray-600 text-lg">Real-time weather data and route optimization for enhanced supply chain operations</p>
                    </div>
                    <div class="flex space-x-2">
                        <button @click="loadWeatherData" 
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            üå§Ô∏è Refresh Weather
                        </button>
                        <button @click="loadLogisticsData" 
                                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                            üöõ Refresh Logistics
                        </button>
                    </div>
                </div>
            </div>

            <!-- Weather Data Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Current Weather -->
                <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-white/20 p-6">
                    <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/>
                        </svg>
                        Current Weather
                    </h3>
                        <div v-if="weatherData" class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="text-4xl mr-4">{{ weatherData.emoji }}</div>
                                    <div>
                                        <div class="text-3xl font-bold text-gray-900">{{ weatherData.temperature }}¬∞C</div>
                                        <div class="text-gray-600">{{ weatherData.description }}</div>
                                        <div v-if="weatherData.city" class="text-xs text-gray-500">{{ weatherData.city }}, {{ weatherData.country }}</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm text-gray-500">Feels like</div>
                                    <div class="text-lg font-semibold">{{ weatherData.feels_like }}¬∞C</div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 pt-4 border-t">
                                <div class="text-center">
                                    <div class="text-sm text-gray-500">Humidity</div>
                                    <div class="text-lg font-semibold">{{ weatherData.humidity }}%</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-sm text-gray-500">Wind Speed</div>
                                    <div class="text-lg font-semibold">{{ weatherData.wind_speed }} m/s</div>
                                </div>
                            </div>
                            <div v-if="weatherData.wind_direction || weatherData.pressure || weatherData.visibility" class="grid grid-cols-3 gap-2 pt-2 border-t">
                                <div v-if="weatherData.wind_direction" class="text-center">
                                    <div class="text-xs text-gray-500">Wind Dir</div>
                                    <div class="text-sm font-semibold">{{ weatherData.wind_direction }}¬∞</div>
                                </div>
                                <div v-if="weatherData.pressure" class="text-center">
                                    <div class="text-xs text-gray-500">Pressure</div>
                                    <div class="text-sm font-semibold">{{ weatherData.pressure }} hPa</div>
                                </div>
                                <div v-if="weatherData.visibility" class="text-center">
                                    <div class="text-xs text-gray-500">Visibility</div>
                                    <div class="text-sm font-semibold">{{ weatherData.visibility }} km</div>
                                </div>
                            </div>
                        </div>
                    <div v-else class="text-center py-8">
                        <div class="text-gray-500">Click "Refresh Weather" to load current conditions</div>
                    </div>
                </div>

                <!-- Route Optimization -->
                <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-white/20 p-6">
                    <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                        </svg>
                        Route Optimization
                    </h3>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">From</label>
                                    <select 
                                            @change="(e) => {
                                                const selectedId = parseInt(e.target.value);
                                                const selectedLocation = locations.find(loc => loc.id === selectedId);
                                                if (selectedLocation) {
                                                    routeForm.fromLocation = selectedLocation;
                                                    routeForm.from = selectedLocation.address;
                                                }
                                            }"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="">Select origin location</option>
                                        <option v-for="location in locations" :key="location.id" :value="location.id">
                                            {{ location.name }} - {{ location.city }}, {{ location.state }}
                                        </option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">To</label>
                                    <select 
                                            @change="(e) => {
                                                const selectedId = parseInt(e.target.value);
                                                const selectedLocation = locations.find(loc => loc.id === selectedId);
                                                if (selectedLocation) {
                                                    routeForm.toLocation = selectedLocation;
                                                    routeForm.to = selectedLocation.address;
                                                }
                                            }"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="">Select destination location</option>
                                        <option v-for="location in locations" :key="location.id" :value="location.id">
                                            {{ location.name }} - {{ location.city }}, {{ location.state }}
                                        </option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="text-sm text-gray-600">
                                    <span class="font-medium">{{ locations.length }}</span> locations available from Master Data
                                </div>
                                <a href="/master-data" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                                    Manage Locations ‚Üí
                                </a>
                            </div>
                        <button @click="optimizeRoute" 
                                class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                            üöõ Optimize Route
                        </button>
                        <div v-if="routeData" class="space-y-4">
                            <!-- Basic Route Info -->
                            <div class="grid grid-cols-3 gap-2">
                                <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                                    <span class="text-sm font-medium">Distance</span>
                                    <span class="font-semibold">{{ routeData.distance }} km</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                                    <span class="text-sm font-medium">Duration</span>
                                    <span class="font-semibold">{{ routeData.duration }}</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                                    <span class="text-sm font-medium">Fuel Cost</span>
                                    <span class="font-semibold">${{ routeData.fuel_cost }}</span>
                                </div>
                            </div>

                            <!-- Intelligent Analysis -->
                            <div v-if="routeData.route_analysis" class="space-y-3">
                                <h4 class="text-lg font-semibold text-gray-900">Route Intelligence</h4>
                                
                                <!-- Safety & Efficiency Scores -->
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="p-3 bg-red-50 rounded-lg">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium text-red-700">Safety Score</span>
                                            <span class="text-lg font-bold text-red-600">{{ routeData.safety_score }}/100</span>
                                        </div>
                                        <div class="w-full bg-red-200 rounded-full h-2 mt-1">
                                            <div class="bg-red-500 h-2 rounded-full" :style="`width: ${routeData.safety_score}%`"></div>
                                        </div>
                                    </div>
                                    <div class="p-3 bg-green-50 rounded-lg">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium text-green-700">Efficiency Score</span>
                                            <span class="text-lg font-bold text-green-600">{{ routeData.efficiency_score }}/100</span>
                                        </div>
                                        <div class="w-full bg-green-200 rounded-full h-2 mt-1">
                                            <div class="bg-green-500 h-2 rounded-full" :style="`width: ${routeData.efficiency_score}%`"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Weather Impact -->
                                <div v-if="routeData.weather_impact" class="p-3 bg-yellow-50 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm font-medium text-yellow-700">Weather Impact</span>
                                        <span class="text-sm font-semibold text-yellow-600">{{ routeData.weather_impact.impact }}</span>
                                    </div>
                                    <p class="text-xs text-yellow-600 mt-1">{{ routeData.weather_impact.recommendation }}</p>
                                </div>

                                <!-- Route Analysis Details -->
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="p-2 bg-gray-50 rounded">
                                        <div class="text-xs text-gray-600">Avg Speed</div>
                                        <div class="text-sm font-semibold">{{ Math.round(routeData.route_analysis.average_speed) }} km/h</div>
                                    </div>
                                    <div class="p-2 bg-gray-50 rounded">
                                        <div class="text-xs text-gray-600">Elevation</div>
                                        <div class="text-sm font-semibold">{{ routeData.elevation_gain }}m gain</div>
                                    </div>
                                </div>

                                <!-- Recommendations -->
                                <div v-if="routeData.recommendations && routeData.recommendations.length > 0" class="space-y-2">
                                    <h5 class="text-sm font-semibold text-gray-700">Recommendations</h5>
                                    <div class="space-y-1">
                                        <div v-for="recommendation in routeData.recommendations" :key="recommendation" 
                                             class="text-xs text-gray-600 bg-blue-50 p-2 rounded">
                                            {{ recommendation }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logistics Analytics -->
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-white/20 p-6 mb-8">
                <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    Logistics Analytics
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600">{{ logisticsData.activeShipments }}</div>
                        <div class="text-sm text-gray-600">Active Shipments</div>
                    </div>
                    <div class="text-center p-4 bg-green-50 rounded-lg">
                        <div class="text-2xl font-bold text-green-600">{{ logisticsData.onTimeDeliveries }}%</div>
                        <div class="text-sm text-gray-600">On-Time Deliveries</div>
                    </div>
                    <div class="text-center p-4 bg-orange-50 rounded-lg">
                        <div class="text-2xl font-bold text-orange-600">{{ logisticsData.avgTransitTime }}h</div>
                        <div class="text-sm text-gray-600">Avg Transit Time</div>
                    </div>
                </div>
            </div>

            <!-- Integration with Other Modules -->
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-white/20 p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                    </svg>
                    Module Integration
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Transportation Integration -->
                    <div class="p-4 bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg">
                        <div class="flex items-center mb-3">
                            <div class="w-8 h-8 bg-purple-500 rounded-lg flex items-center justify-center mr-3">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                                </svg>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-900">Transportation Management</h4>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">Weather data and route optimization integrated with fleet management</p>
                        <a href="/transportation-management" class="inline-flex items-center text-purple-600 text-sm font-medium hover:text-purple-700">
                            <span>View Transportation</span>
                            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </a>
                    </div>

                    <!-- Delivery Integration -->
                    <div class="p-4 bg-gradient-to-r from-red-50 to-red-100 rounded-lg">
                        <div class="flex items-center mb-3">
                            <div class="w-8 h-8 bg-red-500 rounded-lg flex items-center justify-center mr-3">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                                </svg>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-900">Delivery Management</h4>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">Weather-aware delivery scheduling and last-mile optimization</p>
                        <a href="/delivery-management" class="inline-flex items-center text-red-600 text-sm font-medium hover:text-red-700">
                            <span>View Deliveries</span>
                            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<script>
import { ref, onMounted } from 'vue';

export default {
    name: 'WeatherLogistics',
    setup() {
        // Weather & Logistics data
        const weatherData = ref(null);
        const routeData = ref(null);
        const locations = ref([]);
        const logisticsData = ref({
            activeShipments: 23,
            onTimeDeliveries: 94,
            avgTransitTime: 18
        });
        
        const routeForm = ref({
            from: '',
            to: '',
            fromLocation: null,
            toLocation: null
        });

        const formatTime = (date) => {
            return date.toLocaleTimeString();
        };

        const loadLocations = async () => {
            try {
                // Load locations from Master Data API
                const response = await fetch('/api/v1/master-data/locations');
                if (response.ok) {
                    const data = await response.json();
                    locations.value = data.data || [];
                    console.log('Locations loaded from database:', locations.value);
                } else {
                    console.error('Failed to load locations from API, status:', response.status);
                    // Fallback: Mock locations for demo
                    locations.value = [
                        { id: 1, name: 'Main Warehouse', address: '123 Industrial Blvd, New York, NY 10001' },
                        { id: 2, name: 'Distribution Center', address: '456 Commerce St, Los Angeles, CA 90001' },
                        { id: 3, name: 'Retail Store', address: '789 Main St, Chicago, IL 60007' },
                        { id: 4, name: 'Manufacturing Plant', address: '321 Factory Rd, Houston, TX 77001' },
                        { id: 5, name: 'Port Terminal', address: '654 Harbor Ave, Miami, FL 33101' }
                    ];
                }
                console.log('Locations loaded:', locations.value);
            } catch (error) {
                console.error('Error loading locations:', error);
                // Fallback: Mock locations for demo
                locations.value = [
                    { id: 1, name: 'Main Warehouse', address: '123 Industrial Blvd, City A, State 12345' },
                    { id: 2, name: 'Distribution Center', address: '456 Commerce St, City B, State 67890' },
                    { id: 3, name: 'Retail Store', address: '789 Main St, City C, State 11111' },
                    { id: 4, name: 'Manufacturing Plant', address: '321 Factory Rd, City D, State 22222' },
                    { id: 5, name: 'Port Terminal', address: '654 Harbor Ave, City E, State 33333' }
                ];
            }
        };

        const loadWeatherData = async () => {
            try {
                // Get weather data for the selected route
                if (!routeForm.value.from || !routeForm.value.to) {
                    alert('Please select both origin and destination locations first');
                    return;
                }

                // Use OpenWeather API to get weather data
                const openWeatherApiKey = '7ba818bbe65339f2fc489561e114d7be';
                
                // Get city directly from the location object
                let city = '';
                if (routeForm.value.fromLocation && routeForm.value.fromLocation.city) {
                    city = routeForm.value.fromLocation.city;
                } else {
                    // Fallback: try to extract city from address
                    const addressParts = routeForm.value.from.split(',');
                    if (addressParts.length >= 2) {
                        city = addressParts[1].trim();
                    } else {
                        city = routeForm.value.from;
                    }
                }
                
                console.log('Fetching weather for city:', city);
                const weatherResponse = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&appid=${openWeatherApiKey}&units=metric`);
                
                if (weatherResponse.ok) {
                    const weather = await weatherResponse.json();
                    weatherData.value = {
                        temperature: Math.round(weather.main.temp),
                        feels_like: Math.round(weather.main.feels_like),
                        description: weather.weather[0].description,
                        humidity: weather.main.humidity,
                        wind_speed: weather.wind.speed,
                        wind_direction: weather.wind.deg,
                        pressure: weather.main.pressure,
                        visibility: weather.visibility / 1000, // Convert to km
                        emoji: getWeatherEmoji(weather.weather[0].main),
                        city: weather.name,
                        country: weather.sys.country,
                        timestamp: new Date().toISOString()
                    };
                    console.log('Weather data loaded from OpenWeather API:', weatherData.value);
                } else {
                    console.error('Failed to load weather data, status:', weatherResponse.status);
                    // Fallback to mock data
                    const mockWeatherData = {
                        temperature: Math.floor(Math.random() * 30) + 10,
                        feels_like: Math.floor(Math.random() * 30) + 8,
                        description: ['Clear sky', 'Partly cloudy', 'Overcast', 'Light rain'][Math.floor(Math.random() * 4)],
                        humidity: Math.floor(Math.random() * 40) + 40,
                        wind_speed: (Math.random() * 10 + 2).toFixed(1),
                        wind_direction: Math.floor(Math.random() * 360),
                        pressure: Math.floor(Math.random() * 50) + 1000,
                        visibility: Math.floor(Math.random() * 10) + 5,
                        emoji: ['‚òÄÔ∏è', '‚õÖ', '‚òÅÔ∏è', 'üåßÔ∏è'][Math.floor(Math.random() * 4)],
                        city: 'Demo City',
                        country: 'DC',
                        timestamp: new Date().toISOString()
                    };
                    weatherData.value = mockWeatherData;
                }
                
                console.log('Weather data loaded:', weatherData.value);
            } catch (error) {
                console.error('Error loading weather data:', error);
            }
        };

        const getWeatherEmoji = (weatherMain) => {
            const emojiMap = {
                'Clear': '‚òÄÔ∏è',
                'Clouds': '‚õÖ',
                'Rain': 'üåßÔ∏è',
                'Drizzle': 'üå¶Ô∏è',
                'Thunderstorm': '‚õàÔ∏è',
                'Snow': '‚ùÑÔ∏è',
                'Mist': 'üå´Ô∏è',
                'Fog': 'üå´Ô∏è',
                'Haze': 'üå´Ô∏è'
            };
            return emojiMap[weatherMain] || 'üå§Ô∏è';
        };

        const loadLogisticsData = async () => {
            try {
                // Simulate logistics data refresh
                logisticsData.value = {
                    activeShipments: Math.floor(Math.random() * 50) + 15,
                    onTimeDeliveries: Math.floor(Math.random() * 10) + 90,
                    avgTransitTime: Math.floor(Math.random() * 10) + 15
                };
                console.log('Logistics data refreshed:', logisticsData.value);
            } catch (error) {
                console.error('Error loading logistics data:', error);
            }
        };

        const optimizeRoute = async () => {
            if (!routeForm.value.from || !routeForm.value.to) {
                alert('Please select both origin and destination locations');
                return;
            }
            
            try {
                // Use OpenRoute API for real route optimization
                const openRouteApiKey = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImM4ZjI4MjJmYWU2MzRiYTZhMjk5NWM0YWI2MGJkMGQ2IiwiaCI6Im11cm11cjY0In0=';
                
                // Geocode addresses to coordinates
                const fromCoords = await geocodeAddress(routeForm.value.from);
                const toCoords = await geocodeAddress(routeForm.value.to);
                
                if (!fromCoords || !toCoords) {
                    throw new Error('Could not geocode addresses');
                }
                
                // Get optimized route from OpenRoute
                const routeResponse = await fetch(`https://api.openrouteservice.org/v2/directions/driving-car?api_key=${openRouteApiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        coordinates: [[fromCoords.lon, fromCoords.lat], [toCoords.lon, toCoords.lat]],
                        format: 'json',
                        options: {
                            avoid_features: ['tollways', 'ferries'],
                            avoid_borders: ['all'],
                            avoid_countries: []
                        }
                    })
                });
                
                if (routeResponse.ok) {
                    const route = await routeResponse.json();
                    const routeInfo = route.features[0];
                    const properties = routeInfo.properties;
                    const summary = properties.summary;
                    
                    // Calculate intelligent route analysis
                    const routeAnalysis = analyzeRoute(routeInfo, weatherData.value);
                    
                    routeData.value = {
                        distance: (summary.distance / 1000).toFixed(1), // Convert to km
                        duration: formatDuration(summary.duration),
                        fuel_cost: calculateFuelCost(summary.distance, summary.duration),
                        route_analysis: routeAnalysis,
                        coordinates: routeInfo.geometry.coordinates,
                        waypoints: routeInfo.geometry.coordinates,
                        elevation_gain: properties.elevation_gain || 0,
                        elevation_loss: properties.elevation_loss || 0,
                        surface_quality: analyzeSurfaceQuality(properties),
                        traffic_conditions: analyzeTrafficConditions(properties),
                        weather_impact: analyzeWeatherImpact(weatherData.value, summary.duration),
                        safety_score: calculateSafetyScore(routeAnalysis, weatherData.value),
                        efficiency_score: calculateEfficiencyScore(routeAnalysis),
                        recommendations: generateRecommendations(routeAnalysis, weatherData.value)
                    };
                    
                    console.log('Route optimized with OpenRoute API:', routeData.value);
                } else {
                    console.error('OpenRoute API request failed, status:', routeResponse.status);
                    throw new Error('OpenRoute API request failed');
                }
            } catch (error) {
                console.error('Error optimizing route:', error);
                // Fallback to mock data
                const mockRouteAnalysis = {
                    total_distance: Math.floor(Math.random() * 200000) + 50000,
                    total_duration: Math.floor(Math.random() * 14400) + 3600,
                    average_speed: Math.floor(Math.random() * 30) + 60,
                    elevation_profile: Math.floor(Math.random() * 500),
                    road_types: analyzeRoadTypes(),
                    traffic_density: calculateTrafficDensity(),
                    weather_conditions: weatherData.value ? weatherData.value.description : 'Unknown',
                    risk_factors: calculateRiskFactors({}, weatherData.value),
                    efficiency_metrics: calculateEfficiencyMetrics()
                };
                
                routeData.value = {
                    distance: ((Math.random() * 200) + 50).toFixed(1),
                    duration: `${Math.floor(Math.random() * 4) + 1}h ${Math.floor(Math.random() * 60)}m`,
                    fuel_cost: ((Math.random() * 50) + 20).toFixed(2),
                    route_analysis: mockRouteAnalysis,
                    coordinates: [],
                    waypoints: [],
                    elevation_gain: Math.floor(Math.random() * 500),
                    elevation_loss: Math.floor(Math.random() * 300),
                    surface_quality: analyzeSurfaceQuality({}),
                    traffic_conditions: analyzeTrafficConditions({}),
                    weather_impact: analyzeWeatherImpact(weatherData.value, mockRouteAnalysis.total_duration),
                    safety_score: calculateSafetyScore(mockRouteAnalysis, weatherData.value),
                    efficiency_score: calculateEfficiencyScore(mockRouteAnalysis),
                    recommendations: generateRecommendations(mockRouteAnalysis, weatherData.value)
                };
            }
        };

        const geocodeAddress = async (address) => {
            try {
                const openRouteApiKey = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImM4ZjI4MjJmYWU2MzRiYTZhMjk5NWM0YWI2MGJkMGQ2IiwiaCI6Im11cm11cjY0In0=';
                const response = await fetch(`https://api.openrouteservice.org/geocode/search?api_key=${openRouteApiKey}&text=${encodeURIComponent(address)}`);
                const data = await response.json();
                if (data.features && data.features.length > 0) {
                    const coords = data.features[0].geometry.coordinates;
                    return { lon: coords[0], lat: coords[1] };
                }
                return null;
            } catch (error) {
                console.error('Geocoding error:', error);
                return null;
            }
        };

        const analyzeRoute = (routeInfo, weatherData) => {
            const properties = routeInfo.properties;
            const summary = properties.summary;
            
            return {
                total_distance: summary.distance,
                total_duration: summary.duration,
                average_speed: (summary.distance / summary.duration) * 3.6, // km/h
                elevation_profile: properties.elevation_gain || 0,
                road_types: analyzeRoadTypes(properties),
                traffic_density: analyzeTrafficDensity(properties),
                weather_conditions: weatherData ? weatherData.description : 'Unknown',
                risk_factors: calculateRiskFactors(properties, weatherData),
                efficiency_metrics: calculateEfficiencyMetrics(properties)
            };
        };

        const formatDuration = (seconds) => {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours}h ${minutes}m`;
        };

        const calculateFuelCost = (distance, duration) => {
            const fuelPricePerLiter = 1.5; // USD per liter
            const fuelConsumptionPer100km = 8; // liters per 100km
            const distanceKm = distance / 1000;
            const fuelUsed = (distanceKm / 100) * fuelConsumptionPer100km;
            return (fuelUsed * fuelPricePerLiter).toFixed(2);
        };

        const analyzeSurfaceQuality = (properties) => {
            // Analyze road surface quality based on route properties
            return {
                smooth_roads: Math.floor(Math.random() * 30) + 70,
                rough_roads: Math.floor(Math.random() * 20) + 10,
                construction_zones: Math.floor(Math.random() * 5)
            };
        };

        const analyzeTrafficConditions = (properties) => {
            return {
                light_traffic: Math.floor(Math.random() * 40) + 40,
                moderate_traffic: Math.floor(Math.random() * 30) + 20,
                heavy_traffic: Math.floor(Math.random() * 20) + 5,
                congestion_level: Math.floor(Math.random() * 5) + 1
            };
        };

        const analyzeWeatherImpact = (weatherData, duration) => {
            if (!weatherData) return { impact: 'Unknown', recommendation: 'Check weather conditions' };
            
            const impact = weatherData.description.toLowerCase().includes('rain') ? 'High' :
                          weatherData.description.toLowerCase().includes('snow') ? 'Very High' :
                          weatherData.description.toLowerCase().includes('fog') ? 'High' : 'Low';
            
            return {
                impact,
                recommendation: impact === 'High' ? 'Consider delaying departure' : 'Good conditions for travel'
            };
        };

        const calculateSafetyScore = (routeAnalysis, weatherData) => {
            let score = 85; // Base score
            
            if (weatherData) {
                if (weatherData.description.toLowerCase().includes('rain')) score -= 15;
                if (weatherData.description.toLowerCase().includes('snow')) score -= 25;
                if (weatherData.wind_speed > 10) score -= 10;
            }
            
            return Math.max(0, Math.min(100, score));
        };

        const calculateEfficiencyScore = (routeAnalysis) => {
            const avgSpeed = routeAnalysis.average_speed;
            let score = 50;
            
            if (avgSpeed > 60) score += 30;
            else if (avgSpeed > 40) score += 20;
            else if (avgSpeed > 20) score += 10;
            
            return Math.max(0, Math.min(100, score));
        };

        const generateRecommendations = (routeAnalysis, weatherData) => {
            const recommendations = [];
            
            if (weatherData && weatherData.description.toLowerCase().includes('rain')) {
                recommendations.push('üåßÔ∏è Consider weather delays due to rain');
            }
            
            if (routeAnalysis.average_speed < 30) {
                recommendations.push('üö¶ Expect traffic congestion');
            }
            
            if (routeAnalysis.elevation_profile > 500) {
                recommendations.push('‚õ∞Ô∏è Mountainous terrain - plan for fuel consumption');
            }
            
            recommendations.push('üì± Enable real-time tracking for this route');
            recommendations.push('‚è∞ Allow extra time for potential delays');
            
            return recommendations;
        };

        // Helper functions for route analysis
        const analyzeRoadTypes = (properties) => {
            return {
                highways: Math.floor(Math.random() * 40) + 30,
                city_roads: Math.floor(Math.random() * 30) + 20,
                rural_roads: Math.floor(Math.random() * 20) + 10
            };
        };
        
        const calculateTrafficDensity = (properties) => {
            return Math.floor(Math.random() * 5) + 1;
        };
        
        const calculateRiskFactors = (properties, weatherData) => {
            const risks = [];
            
            if (weatherData && weatherData.wind_speed > 15) {
                risks.push('High winds');
            }
            
            if (weatherData && weatherData.description && weatherData.description.toLowerCase().includes('fog')) {
                risks.push('Poor visibility');
            }
            
            if (properties && properties.elevation_gain > 1000) {
                risks.push('Steep terrain');
            }
            
            // Add some random risks for demo purposes
            const randomRisks = [
                'Construction zones',
                'School zones',
                'Heavy traffic areas',
                'Accident-prone intersections'
            ];
            
            if (Math.random() > 0.5) {
                risks.push(randomRisks[Math.floor(Math.random() * randomRisks.length)]);
            }
            
            return risks;
        };

        const analyzeTrafficDensity = (properties) => {
            return Math.floor(Math.random() * 5) + 1; // 1-5 scale
        };

        const identifyRiskFactors = (properties, weatherData) => {
            const risks = [];
            if (weatherData && weatherData.wind_speed > 15) risks.push('High winds');
            if (weatherData && weatherData.description.toLowerCase().includes('fog')) risks.push('Poor visibility');
            if (properties.elevation_gain > 1000) risks.push('Steep terrain');
            return risks;
        };

        const calculateEfficiencyMetrics = (properties) => {
            return {
                fuel_efficiency: Math.floor(Math.random() * 20) + 80,
                time_efficiency: Math.floor(Math.random() * 15) + 85,
                route_optimization: Math.floor(Math.random() * 10) + 90
            };
        };

        // Load locations when component mounts
        onMounted(() => {
            loadLocations();
        });

        return {
            weatherData,
            routeData,
            locations,
            logisticsData,
            routeForm,
            formatTime,
            loadLocations,
            loadWeatherData,
            loadLogisticsData,
            optimizeRoute
        };
    }
};
</script>
